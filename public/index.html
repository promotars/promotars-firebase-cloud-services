<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reCAPTCHA Example</title>
</head>

<body>
    <form id="myForm" style="display: none;">
        <div class="g-recaptcha" data-sitekey="YOUR_SITE_KEY"></div>
        <button onclick="submitForm()">Submit</button>
    </form>
    <button onclick="handleUserAdClick()">Test</button>
</body>

</html>
<!-- 
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/core.min.js" async defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/md5.js" async defer></script>
<script src="https://www.google.com/recaptcha/api.js" async defer></script> -->

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyAJIH6br8wRLROTqukpQJ92X2XZz1ayVXM",
      authDomain: "promotars-prod.firebaseapp.com",
      databaseURL: "https://promotars-prod-default-rtdb.firebaseio.com",
      projectId: "promotars-prod",
      storageBucket: "promotars-prod.appspot.com",
      messagingSenderId: "352154748068",
      appId: "1:352154748068:web:6596382679fa67672fd231",
      measurementId: "G-B7YZWNSSZT"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
  </script>
  
<script>

    const loadScript = (FILE_URL, async = true, type = "text/javascript") => {
        return new Promise((resolve, reject) => {
            try {
                const scriptEle = document.createElement("script");
                scriptEle.type = type;
                scriptEle.async = async;
                scriptEle.src = FILE_URL;

                scriptEle.addEventListener("load", (ev) => {
                    resolve({ status: true });
                });

                scriptEle.addEventListener("error", (ev) => {
                    reject({
                        status: false,
                        message: `Failed to load the script ${FILE_URL}`
                    });
                });

                document.body.appendChild(scriptEle);
            } catch (error) {
                reject(error);
            }
        });
    };

    function validatePromotionId() {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        promotionId = urlParams.get('id') || "";

        if (promotionId.toString().length == 0) {
            console.error('promotionId is empty');
            // redirect to homepage
            // redirectToHomePage();
            return "";
        } else {
            loadJSAndshowReCapcha();
        }
    }

    function redirectToHomePage() {
        window.location.replace("http://nexus.ai");
    }

    function loadJSAndshowReCapcha() {
        const p1 = loadScript("https://www.google.com/recaptcha/api.js")
        const p2 = loadScript("https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/core.min.js")
        const p3 = loadScript("https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/md5.js")


        Promise.all([p1, p2, p3]).then(result => {
            // show
            document.getElementById("myForm").style.display = "block";
            console.log({ result });
        }).catch(error => {
            console.log('An Error Occured');
        });


    }

    function handleUserAdClick() {
        // User Agent:
        const currentUserAgent = navigator.userAgent;
        // Viewport Dimensions:
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        // Screen Dimensions:
        const screenWidth = screen.width;
        const screenHeight = screen.height;
        // Device Pixel Ratio:
        const devicePixelRatio = window.devicePixelRatio;
        // Language Preferences:
        const userLanguage = navigator.language;
        // Touch Support:
        const maxTouchPoints = navigator.maxTouchPoints || 0;

        // match with stored, if mismatch then user is trying to mock user agent
        // so if exist in Local Storage use that data
        console.log("currentUserAgent", currentUserAgent);
        console.log("viewportWidth", viewportWidth);
        console.log("viewportHeight", viewportHeight);
        console.log("screenWidth", screenWidth);
        console.log("screenHeight", screenHeight);
        console.log("devicePixelRatio", devicePixelRatio);
        console.log("userLanguage", userLanguage);
        console.log("maxTouchPoints", maxTouchPoints);

        const idUnique = currentUserAgent.concat(viewportWidth,
            viewportHeight,
            screenWidth,
            screenHeight,
            devicePixelRatio,
            userLanguage,
            maxTouchPoints);
        // console.log("idUnique", idUnique);
        console.log("idUnique", CryptoJS.MD5(idUnique).toString());

        // update document in firebase
    }
    function submitForm() {
        const gRecaptchaResponse = grecaptcha.getResponse();
        const secretKey = 'YOUR_SECRET_KEY'; // Replace with your Secret Key
        const verificationURL = `https://www.google.com/recaptcha/api/siteverify?secret=${secretKey}&response=${gRecaptchaResponse}`;

        // Perform the CAPTCHA verification
        fetch(verificationURL, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // CAPTCHA verification successful, call your custom function
                    handleUserAdClick();
                } else {
                    // CAPTCHA verification failed
                    alert('CAPTCHA verification failed. Please try again.');
                }
            })
            .catch(error => {
                alert('Error verifying CAPTCHA:', error);
            });
    }

    validatePromotionId();
</script>